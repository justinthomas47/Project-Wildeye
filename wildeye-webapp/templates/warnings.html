<!-- warnings.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <title>WildEye - Warning System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            min-height: 100vh;
        }
        .border-l-6 {
            border-left-width: 6px;
        }
        .tab-active {
            background-color: #fff;
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body>
    {% include "includes/navbar.html" %}
    
    <div class="min-h-screen bg-gray-100">
        <div class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Warning System</h1>
                
                <div class="flex space-x-4">
                    <a href="{{ url_for('notification_settings') }}" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Notification Settings
                    </a>
                    <button id="btnTestNotification" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                        Test Notifications
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b mb-6">
                <button class="tab-button px-6 py-3 tab-active" data-tab="active">
                    Active Warnings
                </button>
                <button class="tab-button px-6 py-3" data-tab="all">
                    All Warnings
                </button>
            </div>
            
            {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6" role="alert">
                <p>{{ error }}</p>
            </div>
            {% endif %}
            
            <!-- Notification test result -->
            <div id="notificationTestResult" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6" role="alert">
                <p id="notificationTestMessage"></p>
            </div>
            
            <!-- Active Warnings Tab -->
            <div id="active-tab-content" class="tab-content grid gap-6">
                {% set active_warnings = [] %}
                {% for warning in warnings %}
                    {% if warning.active %}
                        {% set _ = active_warnings.append(warning) %}
                    {% endif %}
                {% endfor %}
                
                {% if active_warnings %}
                    {% for warning in active_warnings %}
                    <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden
                        {% if warning.severity == 'high' %}border-l-6 border-red-500
                        {% elif warning.severity == 'medium' %}border-l-6 border-yellow-500
                        {% else %}border-l-6 border-blue-500{% endif %}">
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <h3 class="text-xl font-semibold 
                                            {% if warning.severity == 'high' %}text-red-700
                                            {% elif warning.severity == 'medium' %}text-yellow-700
                                            {% else %}text-blue-700{% endif %}">
                                            {{ warning.type }}
                                        </h3>
                                        <span class="ml-3 px-3 py-1 rounded-full text-sm font-medium
                                            {% if warning.severity == 'high' %}bg-red-100 text-red-800
                                            {% elif warning.severity == 'medium' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-blue-100 text-blue-800{% endif %}">
                                            {{ warning.severity|title }}
                                        </span>
                                    </div>
                                    <p class="text-gray-500 text-sm mb-2">{{ warning.timestamp.strftime('%Y-%m-%d %H:%M:%S') if warning.timestamp else 'Unknown time' }}</p>
                                    <p class="text-gray-700 mb-2">{{ warning.message }}</p>
                                    <p class="text-gray-600 text-sm mb-4">
                                        <strong>Camera:</strong> {{ warning.camera_name }}
                                        {% if warning.google_maps_link %}
                                        | <a href="{{ warning.google_maps_link }}" target="_blank" class="text-blue-600 hover:underline">View Location</a>
                                        {% endif %}
                                    </p>
                                    
                                    <div class="mb-4 text-sm">
                                        <span class="mr-4">
                                            <span class="font-medium">Email:</span> 
                                            {% if warning.notification_status.email %}
                                            <span class="text-green-600">Sent ✓</span>
                                            {% else %}
                                            <span class="text-gray-400">Not sent</span>
                                            {% endif %}
                                        </span>
                                        <span class="mr-4">
                                            <span class="font-medium">SMS:</span> 
                                            {% if warning.notification_status.sms %}
                                            <span class="text-green-600">Sent ✓</span>
                                            {% else %}
                                            <span class="text-gray-400">Not sent</span>
                                            {% endif %}
                                        </span>
                                        <span>
                                            <span class="font-medium">Telegram:</span> 
                                            {% if warning.notification_status.telegram %}
                                            <span class="text-green-600">Sent ✓</span>
                                            {% else %}
                                            <span class="text-gray-400">Not sent</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    {% if warning.screenshot_url %}
                                    <div class="mb-4">
                                        <a href="{{ warning.screenshot_url }}" target="_blank" class="text-blue-600 hover:underline">
                                            View Screenshot
                                        </a>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="flex items-center space-x-4">
                                        <button class="btn-acknowledge px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors duration-200"
                                                data-warning-id="{{ warning.warning_id }}">
                                            {% if warning.acknowledged %}
                                            Acknowledged
                                            {% else %}
                                            Acknowledge
                                            {% endif %}
                                        </button>
                                        <button class="btn-resolve px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors duration-200"
                                                data-warning-id="{{ warning.warning_id }}">
                                            Resolve
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-md p-8 text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01"></path>
                        </svg>
                        <p class="text-gray-600 text-lg">No active warnings</p>
                        <p class="text-gray-500 mt-2">All systems are operating normally</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- All Warnings Tab -->
            <div id="all-tab-content" class="tab-content hidden grid gap-6">
                {% if warnings %}
                    {% for warning in warnings %}
                    <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden
                        {% if warning.severity == 'high' %}border-l-6 border-red-500
                        {% elif warning.severity == 'medium' %}border-l-6 border-yellow-500
                        {% else %}border-l-6 border-blue-500{% endif %}
                        {% if not warning.active %}opacity-75{% endif %}">
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <h3 class="text-xl font-semibold 
                                            {% if warning.severity == 'high' %}text-red-700
                                            {% elif warning.severity == 'medium' %}text-yellow-700
                                            {% else %}text-blue-700{% endif %}">
                                            {{ warning.type }}
                                        </h3>
                                        <span class="ml-3 px-3 py-1 rounded-full text-sm font-medium
                                            {% if warning.severity == 'high' %}bg-red-100 text-red-800
                                            {% elif warning.severity == 'medium' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-blue-100 text-blue-800{% endif %}">
                                            {{ warning.severity|title }}
                                        </span>
                                        {% if not warning.active %}
                                        <span class="ml-3 px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                            Resolved
                                        </span>
                                        {% endif %}
                                    </div>
                                    <p class="text-gray-500 text-sm mb-2">{{ warning.timestamp.strftime('%Y-%m-%d %H:%M:%S') if warning.timestamp else 'Unknown time' }}</p>
                                    <p class="text-gray-700 mb-2">{{ warning.message }}</p>
                                    <p class="text-gray-600 text-sm mb-4">
                                        <strong>Camera:</strong> {{ warning.camera_name }}
                                        {% if warning.google_maps_link %}
                                        | <a href="{{ warning.google_maps_link }}" target="_blank" class="text-blue-600 hover:underline">View Location</a>
                                        {% endif %}
                                    </p>
                                    
                                    <div class="mb-4 text-sm">
                                        <span class="mr-4">
                                            <span class="font-medium">Email:</span> 
                                            {% if warning.notification_status.email %}
                                            <span class="text-green-600">Sent ✓</span>
                                            {% else %}
                                            <span class="text-gray-400">Not sent</span>
                                            {% endif %}
                                        </span>
                                        <span class="mr-4">
                                            <span class="font-medium">SMS:</span> 
                                            {% if warning.notification_status.sms %}
                                            <span class="text-green-600">Sent ✓</span>
                                            {% else %}
                                            <span class="text-gray-400">Not sent</span>
                                            {% endif %}
                                        </span>
                                        <span>
                                            <span class="font-medium">Telegram:</span> 
                                            {% if warning.notification_status.telegram %}
                                            <span class="text-green-600">Sent ✓</span>
                                            {% else %}
                                            <span class="text-gray-400">Not sent</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    {% if warning.screenshot_url %}
                                    <div class="mb-4">
                                        <a href="{{ warning.screenshot_url }}" target="_blank" class="text-blue-600 hover:underline">
                                            View Screenshot
                                        </a>
                                    </div>
                                    {% endif %}
                                    
                                    {% if warning.active %}
                                    <div class="flex items-center space-x-4">
                                        <button class="btn-acknowledge px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors duration-200"
                                                data-warning-id="{{ warning.warning_id }}">
                                            {% if warning.acknowledged %}
                                            Acknowledged
                                            {% else %}
                                            Acknowledge
                                            {% endif %}
                                        </button>
                                        <button class="btn-resolve px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors duration-200"
                                                data-warning-id="{{ warning.warning_id }}">
                                            Resolve
                                        </button>
                                    </div>
                                    {% else %}
                                    <div class="text-sm text-gray-500">
                                        Resolved at: {{ warning.resolved_at.strftime('%Y-%m-%d %H:%M:%S') if warning.resolved_at else 'Unknown' }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-md p-8 text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01"></path>
                        </svg>
                        <p class="text-gray-600 text-lg">No warnings found</p>
                        <p class="text-gray-500 mt-2">No warnings have been recorded yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                    
                    // Add active class to clicked button
                    button.classList.add('tab-active');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    // Show selected tab content
                    const tabName = button.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
                });
            });
            
            // Handle acknowledge button
            const acknowledgeButtons = document.querySelectorAll('.btn-acknowledge');
            acknowledgeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.textContent.trim() === 'Acknowledged') {
                        return; // Already acknowledged
                    }
                    
                    const warningId = button.getAttribute('data-warning-id');
                    acknowledgeWarning(warningId, button);
                });
            });
            
            // Handle resolve button
            const resolveButtons = document.querySelectorAll('.btn-resolve');
            resolveButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const warningId = button.getAttribute('data-warning-id');
                    resolveWarning(warningId);
                });
            });
            
            // Test notification button
            const testButton = document.getElementById('btnTestNotification');
            if (testButton) {
                testButton.addEventListener('click', () => {
                    testNotifications();
                });
            }
        });
        
        // Function to acknowledge warning
        function acknowledgeWarning(warningId, button) {
            fetch(`/warning/${warningId}/acknowledge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.textContent = 'Acknowledged';
                    button.classList.add('bg-blue-100');
                    button.classList.add('text-blue-700');
                } else {
                    alert('Error acknowledging warning: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error acknowledging warning. Please try again.');
            });
        }
        
        // Function to resolve warning
        function resolveWarning(warningId) {
            fetch(`/warning/${warningId}/resolve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh the page to update the UI
                    window.location.reload();
                } else {
                    alert('Error resolving warning: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error resolving warning. Please try again.');
            });
        }
        
        // Function to test notifications
        function testNotifications() {
            fetch('/test_notifications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('notificationTestResult');
                const messageEl = document.getElementById('notificationTestMessage');
                
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('bg-green-100', 'bg-red-100', 'border-green-400', 'border-red-400', 'text-green-700', 'text-red-700');
                
                if (data.success) {
                    resultDiv.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    
                    let message = "Test notifications sent successfully:<br>";
                    if (data.email) message += "✓ Email<br>";
                    else message += "✗ Email (disabled or failed)<br>";
                    
                    if (data.sms) message += "✓ SMS<br>";
                    else message += "✗ SMS (disabled or failed)<br>";
                    
                    if (data.telegram) message += "✓ Telegram<br>";
                    else message += "✗ Telegram (disabled or failed)<br>";
                    
                    messageEl.innerHTML = message;
                } else {
                    resultDiv.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    messageEl.textContent = 'Error testing notifications: ' + data.error;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const resultDiv = document.getElementById('notificationTestResult');
                const messageEl = document.getElementById('notificationTestMessage');
                
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('bg-green-100');
                resultDiv.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                messageEl.textContent = 'Error testing notifications. Please try again.';
            });
        }
    </script>

    <script type="module">
        import { initAuthStateObserver, logout } from '/static/js/firebase-auth.js';
        initAuthStateObserver();
        window.logOut = logout;
    </script>
</body>
</html>